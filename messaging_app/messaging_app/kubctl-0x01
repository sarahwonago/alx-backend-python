#!/bin/bash
# kubctl-0x01 - Scale Django app and test performance in Kubernetes

set -e  # Exit on any error

DEPLOYMENT_NAME="messaging-app-deployment"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default" 
PORT=8000

echo "Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas=3 --namespace="$NAMESPACE"

echo "Waiting for pods to be ready..."
kubectl rollout status deployment/"$DEPLOYMENT_NAME" --namespace="$NAMESPACE"

echo "Verifying running pods..."
kubectl get pods --namespace="$NAMESPACE" -o wide

echo "Getting ClusterIP of service..."
CLUSTER_IP=$(kubectl get svc "$SERVICE_NAME" --namespace="$NAMESPACE" -o jsonpath='{.spec.clusterIP}')

if ! command -v wrk >/dev/null 2>&1; then
    echo "wrk is not installed."
    echo "➡ Install wrk: https://github.com/wg/wrk"
    exit 1
fi

echo "⚡ Running load test with wrk..."
wrk -t4 -c100 -d30s http://$CLUSTER_IP:$PORT/

if ! command -v kubectl >/dev/null 2>&1; then
    echo "kubectl not found. Please install Kubernetes CLI."
    exit 1
fi

if ! kubectl top pods &>/dev/null; then
    echo "Metrics server not found. Please install metrics-server to use 'kubectl top'."
    echo "➡ Install: https://github.com/kubernetes-sigs/metrics-server"
    exit 1
fi

echo "Monitoring resource usage..."
kubectl top pods --namespace="$NAMESPACE"
